<!DOCTYPE html><html lang="en"><head><title>lib/workspace</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="lib/workspace"><meta name="groc-project-path" content="lib/workspace.js"><meta name="groc-github-url" content="http://github.com/NexusDevelopment/dapple"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="http://github.com/NexusDevelopment/dapple/blob/master/lib/workspace.js">lib/workspace.js</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="dapple-workspace-and-dev-environment-object">dapple workspace and dev environment object</h1>
<p>Most interactions with the filestystem should be contained to this module.
(<code>.dapplerc</code>, <code>dappfile</code>, subpackages, etc.) This should be one of the few
stateful modules in all of <code>lib/dapple</code>.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A workspace will be initialized when you run any <code>dapple</code> command. It is
dapple&#39;s internal configuration object and single point of interaction with the
filesystem.</p>
<p>It will look for the <code>.dapplerc</code> file in <code>DAPPLERC</code> env var or <code>~/.dapplerc</code> It
will look for the <code>dappfile</code> in all parents in order (like <code>git</code> command and
<code>.git</code> folder)</p></div></div><div class="code"><div class="wrapper"><span class="hljs-pi">
"use strict"</span>;

<span class="hljs-keyword">var</span> req = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lazreq'</span>)({
    vinyl: <span class="hljs-string">'vinyl-fs'</span>
})

<span class="hljs-keyword">var</span> constants = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./constants"</span>);
<span class="hljs-keyword">var</span> DappleRC = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/dapplerc.js'</span>);
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./file"</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">var</span> readyaml = <span class="hljs-built_in">require</span>(<span class="hljs-string">"read-yaml"</span>);

<span class="hljs-built_in">module</span>.exports = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Workspace</span> </span>{

    constructor(wsPath) {
        <span class="hljs-keyword">if</span>( wsPath === <span class="hljs-literal">undefined</span> ) {
            wsPath = process.cwd();
        }
        <span class="hljs-keyword">this</span>.package_root = Workspace.findWorkspaceRoot(wsPath);
        <span class="hljs-keyword">if</span>( <span class="hljs-keyword">this</span>.package_root === <span class="hljs-literal">undefined</span> ) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Couldn't find workspace. Use `dapple init`"</span>);
        }
        <span class="hljs-keyword">this</span>._dappfile = <span class="hljs-keyword">this</span>.loadDappfile();
    }

    static initialize(root_dir) {
        fs.writeFileSync(path.join(root_dir, constants.DAPPFILE_FILENAME),
                         constants.DEFAULT_DAPPFILE_CONTENTS);
        <span class="hljs-keyword">var</span> dappfile = constants.DEFAULT_DAPPFILE_OBJECT;
        <span class="hljs-keyword">var</span> layout = dappfile.layout || {};
        <span class="hljs-keyword">for</span>( <span class="hljs-keyword">let</span> dir <span class="hljs-keyword">in</span> layout ) {
            fs.mkdirp.sync(path.join(root_dir, layout[dir]));
        }
    }

    static findWorkspaceRoot(command_dir) {
        <span class="hljs-keyword">var</span> location = command_dir;
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">var</span> dappfile_path = path.join(location, constants.DAPPFILE_FILENAME );
            <span class="hljs-keyword">if</span>( fs.existsSync(dappfile_path) ) {
                <span class="hljs-keyword">return</span> location;
            }
            location = path.join(location, <span class="hljs-string">".."</span>);
        } <span class="hljs-keyword">while</span>( location != <span class="hljs-string">"/"</span> );
        <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    }

    static getDappleRC(opts) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DappleRC(opts);
    }

    static writeDappleRC(rcPath, data) {
        <span class="hljs-keyword">return</span> DappleRC.writeSync(rcPath, data);
    }

    get dappfile() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._dappfile || {};
    }

    getLayout() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.dappfile.layout || {};
    }

    getBuildDir() {
        <span class="hljs-keyword">return</span> path.join(<span class="hljs-keyword">this</span>.package_root,
                         <span class="hljs-keyword">this</span>.getLayout().build_dir || <span class="hljs-string">'build'</span>);
    }

    getBuildDest() {
        <span class="hljs-keyword">return</span> req.vinyl.dest(<span class="hljs-keyword">this</span>.getBuildDir());
    }

    getSourceDir() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getLayout().sol_sources;
    }

    getSourcePath() {
        <span class="hljs-keyword">var</span> sourceRoot = <span class="hljs-keyword">this</span>.package_root;

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.getLayout().sol_sources) {
            sourceRoot = path.join(sourceRoot, <span class="hljs-keyword">this</span>.getSourceDir());
        }

        <span class="hljs-keyword">return</span> sourceRoot;
    }

    getPackagesDir() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getLayout().packages_director || <span class="hljs-string">"dapple_packages"</span>;
    }

    getPackagesPath() {
        <span class="hljs-keyword">return</span> path.join(<span class="hljs-keyword">this</span>.package_root, <span class="hljs-keyword">this</span>.getPackagesDir());
    }

    getIgnoreGlobs() {
        <span class="hljs-keyword">var</span> globs = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> glob <span class="hljs-keyword">of</span> (<span class="hljs-keyword">this</span>.dappfile.ignore || [])) {
            globs.push(path.join(<span class="hljs-keyword">this</span>.getSourceDir(), glob));
        }
        <span class="hljs-keyword">return</span> globs;
    }

    getPreprocessorVars() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.dappfile.preprocessor_vars;
    }

    getEnvironment() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.dappfile.environment || <span class="hljs-string">'default'</span>;
    }

    getEnvironments() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.dappfile.environments;
    }

    getDappfilePath() {
        <span class="hljs-keyword">return</span> path.join(<span class="hljs-keyword">this</span>.package_root, constants.DAPPFILE_FILENAME);
    }

    loadDappfile(dappfile_path) {
        <span class="hljs-keyword">if</span>( dappfile_path === <span class="hljs-literal">undefined</span> ) {
            dappfile_path = <span class="hljs-keyword">this</span>.getDappfilePath();
        }
        <span class="hljs-keyword">return</span> readyaml.sync(dappfile_path);
    }

    writeDappfile() {
        <span class="hljs-keyword">return</span> fs.writeYamlSync(<span class="hljs-keyword">this</span>.getDappfilePath(), <span class="hljs-keyword">this</span>.dappfile);
    }

    addDependency(packagePath) {
        <span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">this</span>.dappfile.dependencies ) {
            <span class="hljs-keyword">this</span>.dappfile.dependencies = {};
        }
        <span class="hljs-keyword">this</span>.dappfile.dependencies[path.basename(packagePath)] = packagePath;
    }

    getDependencies() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.dappfile.dependencies || {};
    }
}</div></div></div></div></body></html>