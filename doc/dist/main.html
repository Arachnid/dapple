<!DOCTYPE html><html lang="en"><head><title>main</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="main"><meta name="groc-project-path" content="cmd/main.js"><meta name="groc-github-url" content="http://github.com/NexusDevelopment/dapple"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="http://github.com/NexusDevelopment/dapple/blob/master/cmd/main.js">cmd/main.js</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-pi">
"use strict"</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is the file that gets executed when you run <code>dapple</code>. It uses <code>docopt</code>
to parse the arguments passed in.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> Builder = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../lib/build"</span>);
<span class="hljs-keyword">var</span> DappleRCPrompter = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../lib/dapplerc_prompter.js"</span>);
<span class="hljs-keyword">var</span> deasync = <span class="hljs-built_in">require</span>(<span class="hljs-string">'deasync'</span>);
<span class="hljs-keyword">var</span> docopt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'docopt'</span>);
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/file.js'</span>);
<span class="hljs-keyword">var</span> Installer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/installer.js'</span>);
<span class="hljs-keyword">var</span> inquirer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'inquirer'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">var</span> pipelines = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../lib/pipelines"</span>);
<span class="hljs-keyword">var</span> userHome = <span class="hljs-built_in">require</span>(<span class="hljs-string">'user-home'</span>);
<span class="hljs-keyword">var</span> VMTest = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../lib/vmtest"</span>);
<span class="hljs-keyword">var</span> Workspace = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../lib/workspace"</span>);

<span class="hljs-keyword">var</span> doc = fs.readFileSync(__dirname+<span class="hljs-string">"/docopt.txt"</span>).toString();
<span class="hljs-keyword">var</span> cli = docopt.docopt(doc);
<span class="hljs-keyword">var</span> rc = Workspace.getDappleRC();

<span class="hljs-keyword">if</span> (cli.config || <span class="hljs-keyword">typeof</span>(rc.path) === <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-keyword">var</span> homeRC = path.join(userHome, <span class="hljs-string">'.dapplerc'</span>);

    <span class="hljs-keyword">var</span> confirmed;
    <span class="hljs-keyword">var</span> chosen = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (rc.path !== <span class="hljs-literal">undefined</span> &amp;&amp; rc.path === homeRC) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"You already have a .dapplerc in your home directory!"</span>);
        inquirer.prompt([{
            type: <span class="hljs-string">'confirm'</span>,
            message: <span class="hljs-string">"Proceeding will overwrite that file. Proceed?"</span>,
            name: <span class="hljs-string">"confirmed"</span>,
            <span class="hljs-keyword">default</span>: <span class="hljs-literal">false</span>
        }], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>) </span>{
            chosen = <span class="hljs-literal">true</span>;
            confirmed = res.confirmed;
        })
        deasync.loopWhile(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<span class="hljs-keyword">return</span> !chosen;});

        <span class="hljs-keyword">if</span> (confirmed) {
            Workspace.writeDappleRC(homeRC, DappleRCPrompter.prompt());
        }

    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"No configuration found! Generating..."</span>);
        Workspace.writeDappleRC(homeRC, DappleRCPrompter.prompt());
    }
    rc = Workspace.getDappleRC();
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the user ran the <code>install</code> command, we&#39;re going to walk the dependencies
in the dappfile and pull them in as git submodules, if the current package is
a git repository. Otherwise we&#39;ll just clone them.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">if</span>( cli.install ) {
    <span class="hljs-keyword">var</span> workspace = <span class="hljs-keyword">new</span> Workspace();

    <span class="hljs-keyword">var</span> packages;
    <span class="hljs-keyword">if</span> ( cli[<span class="hljs-string">'&lt;package&gt;'</span>] ) {
        packages = [cli[<span class="hljs-string">'&lt;package&gt;'</span>]];
    } <span class="hljs-keyword">else</span> {
        packages = workspace.getDependencies();
    }

    Installer.install(packages, <span class="hljs-built_in">console</span>);

    <span class="hljs-keyword">if</span> ( cli[<span class="hljs-string">'--save'</span>] &amp;&amp; cli[<span class="hljs-string">'&lt;package&gt;'</span>] ) {
        workspace.addDependency(cli[<span class="hljs-string">'&lt;package&gt;'</span>]);
        workspace.writeDappfile();
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the user ran the <code>build</code> command, we&#39;re going to open the current directory
as if it were a package and commence with building.</p></div></div><div class="code"><div class="wrapper">} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( cli.build ) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Building..."</span>);

    <span class="hljs-keyword">var</span> workspace = <span class="hljs-keyword">new</span> Workspace();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Run our build pipeline.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> jsBuildPipeline = pipelines
        .JSBuildPipeline({
            environment: cli[<span class="hljs-string">'--environment'</span>] || workspace.getEnvironment(),
            environments: workspace.getEnvironments(),
            ignore: workspace.getIgnoreGlobs(),
            packageRoot: workspace.package_root,
            preprocessorVars: workspace.getPreprocessorVars(),
            sourceRoot: workspace.getSourceDir()
        });

    <span class="hljs-keyword">if</span> (!jsBuildPipeline) <span class="hljs-keyword">return</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Write output to filesystem.</p></div></div><div class="code"><div class="wrapper">    jsBuildPipeline.pipe(workspace.getBuildDest());</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If they ran the <code>init</code> command, we just set up the current directory as a
Dapple package and exit.</p></div></div><div class="code"><div class="wrapper">} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cli.init) {
    Workspace.initialize(process.cwd());</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If they ran the <code>test</code> command, we&#39;re going to run our build pipeline and
then pass the output on to our test pipeline, finally spitting out the
results to stdout and stderr (in case of failure).</p></div></div><div class="code"><div class="wrapper">} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cli.test) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Testing..."</span>);

    <span class="hljs-keyword">var</span> workspace = <span class="hljs-keyword">new</span> Workspace();
    <span class="hljs-keyword">var</span> env = cli[<span class="hljs-string">'--environment'</span>] || workspace.getEnvironment();
    <span class="hljs-keyword">var</span> initStream;

    <span class="hljs-keyword">if</span> (cli[<span class="hljs-string">'--skip-build'</span>]) {
        initStream = pipelines.BuiltClassesPipeline(workspace.getBuildDir());

    } <span class="hljs-keyword">else</span> {
        initStream = pipelines
            .BuildPipeline({
                ignore: workspace.getIgnoreGlobs(),
                packageRoot: workspace.package_root,
                preprocessorVars: workspace.getPreprocessorVars(),
                sourceRoot: workspace.getSourceDir()
            })
            .pipe(workspace.getBuildDest());
    }

    <span class="hljs-keyword">if</span> (!(env <span class="hljs-keyword">in</span> rc.data.environments)) {
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Environment not defined: "</span> + env);

    } <span class="hljs-keyword">else</span> {
        initStream
            .pipe(pipelines.TestPipeline({
                web3: rc.data.environments[env].ethereum || <span class="hljs-string">'internal'</span>
            }));
    }
}</div></div></div></div></body></html>